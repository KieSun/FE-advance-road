# ä½ ä¸çŸ¥é“çš„é«˜æ€§èƒ½å®ç°æ·±æ‹·è´çš„æ–¹å¼
## ä¼ ç»Ÿæ·±æ‹·è´çš„é—®é¢˜

JS ä¸­æœ‰ä¸ªé‡è¦çš„ç±»å‹å«åšå¼•ç”¨ç±»å‹ã€‚è¿™ç§ç±»å‹åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºä¼ é€’çš„å€¼æ˜¯å¼•ç”¨ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å‘ç”Ÿä¸€äº›å‰¯ä½œç”¨ï¼Œæ¯”å¦‚ï¼š

```js
let a = { age: 1 }
let b = a
b.age = 2
```

ä¸Šè¿°ä»£ç çš„å†™æ³•ä¼šé€ æˆ `a` å’Œ `b` çš„å±æ€§éƒ½è¢«ä¿®æ”¹äº†ã€‚å¤§å®¶åœ¨æ—¥å¸¸å¼€å‘ä¸­è‚¯å®šä¸æƒ³å‡ºç°è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥éƒ½ä¼šç”¨ä¸Šä¸€äº›æ‰‹æ®µå»æ–­å¼€å®ƒä»¬çš„å¼•ç”¨è¿æ¥ã€‚å¯¹äºä¸Šè¿°çš„æ•°æ®ç»“æ„æ¥è¯´ï¼Œæµ…æ‹·è´å°±èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚

```js
let b = { ...a }
b.age = 2
```

ä½†æ˜¯æµ…æ‹·è´åªèƒ½æ–­å¼€ä¸€å±‚çš„å¼•ç”¨ï¼Œå¦‚æœæ•°æ®ç»“æ„æ˜¯å¤šå±‚å¯¹è±¡çš„è¯ï¼Œæµ…æ‹·è´å°±ä¸èƒ½è§£å†³é—®é¢˜äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ç”¨åˆ°æ·±æ‹·è´ã€‚

æ·±æ‹·è´çš„åšæ³•ä¸€èˆ¬åˆ†ä¸¤ç§ï¼š

- `JSON.parse(JSON.stringify(a))`
- é€’å½’æµ…æ‹·è´

ç¬¬ä¸€ç§åšæ³•å­˜åœ¨ä¸€äº›å±€é™ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¹¶ä¸èƒ½ä½¿ç”¨ï¼Œå› æ­¤è¿™é‡Œå°±ä¸æäº†ï¼›ç¬¬äºŒç§åšæ³•ä¸€èˆ¬æ˜¯å·¥å…·åº“ä¸­çš„æ·±æ‹·è´å‡½æ•°å®ç°æ–¹å¼ï¼Œæ¯”å¦‚ loadash ä¸­çš„ `cloneDeep`ã€‚è™½ç„¶è¿™ç§åšæ³•èƒ½è§£å†³ç¬¬ä¸€ç§åšæ³•çš„å±€é™ï¼Œä½†æ˜¯å¯¹äºåºå¤§çš„æ•°æ®æ¥è¯´æ€§èƒ½å¹¶ä¸å¥½ï¼Œå› ä¸ºéœ€è¦æŠŠæ•´ä¸ªå¯¹è±¡éƒ½éå†ä¸€éã€‚

é‚£ä¹ˆæ˜¯å¦å¯ä»¥æœ‰ä¸€ç§å®ç°çš„åšæ³•ï¼Œåªæœ‰å½“å±æ€§ä¿®æ”¹ä»¥åæ‰å¯¹è¿™éƒ¨åˆ†æ•°æ®åšæ·±æ‹·è´ï¼Œåˆèƒ½è§£å†³ `JSON.parse(JSON.stringify(a))` çš„å±€é™å‘¢ã€‚è¿™ç§åšæ³•å½“ç„¶æ˜¯å­˜åœ¨çš„ï¼Œå”¯ä¸€çš„ç‚¹æ˜¯æˆ‘ä»¬å¦‚ä½•çŸ¥é“ç”¨æˆ·ä¿®æ”¹äº†ä»€ä¹ˆå±æ€§ï¼Ÿ

ç­”æ¡ˆæ˜¯ `Proxy`ï¼Œé€šè¿‡æ‹¦æˆª `set` å’Œ `get` å°±èƒ½è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ï¼Œå½“ç„¶ `Object.defineProperty()` ä¹Ÿå¯ä»¥ã€‚å…¶å® [Immer](https://github.com/immerjs/immer) è¿™ä¸ªåº“å°±æ˜¯ç”¨äº†è¿™ç§åšæ³•æ¥ç”Ÿæˆä¸å¯å˜å¯¹è±¡çš„ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥è¯•ç€é€šè¿‡ `Proxy` æ¥å®ç°é«˜æ€§èƒ½ç‰ˆçš„æ·±æ‹·è´ã€‚

## å®ç°

å…ˆè¯´ä¸‹æ•´ä½“æ ¸å¿ƒæ€è·¯ï¼Œå…¶å®å°±ä¸‰ç‚¹ï¼š

- æ‹¦æˆª `set`ï¼Œæ‰€æœ‰èµ‹å€¼éƒ½åœ¨ copy ï¼ˆåŸæ•°æ®æµ…æ‹·è´çš„å¯¹è±¡ï¼‰ä¸­è¿›è¡Œï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“åˆ°åŸå¯¹è±¡
- æ‹¦æˆª `get`ï¼Œé€šè¿‡å±æ€§æ˜¯å¦ä¿®æ”¹çš„é€»è¾‘åˆ†åˆ«ä» copy æˆ–è€…åŸæ•°æ®ä¸­å–å€¼
- æœ€åç”Ÿæˆä¸å¯å˜å¯¹è±¡çš„æ—¶å€™éå†åŸå¯¹è±¡ï¼Œåˆ¤æ–­å±æ€§æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­æ˜¯å¦å­˜åœ¨ copyã€‚å¦‚æœæ²¡æœ‰ä¿®æ”¹è¿‡çš„è¯ï¼Œå°±è¿”å›åŸå±æ€§ï¼Œå¹¶ä¸”ä¹Ÿä¸å†éœ€è¦å¯¹å­å±æ€§å¯¹è±¡éå†ï¼Œæé«˜äº†æ€§èƒ½ã€‚å¦‚æœä¿®æ”¹è¿‡çš„è¯ï¼Œå°±éœ€è¦æŠŠ copy èµ‹å€¼åˆ°æ–°å¯¹è±¡ä¸Šï¼Œå¹¶ä¸”é€’å½’éå†

æ¥ä¸‹æ¥æ˜¯å®ç°ï¼Œæˆ‘ä»¬æ—¢ç„¶è¦ç”¨ `Proxy` å®ç°ï¼Œé‚£ä¹ˆè‚¯å®šå¾—ç”Ÿæˆä¸€ä¸ª `Proxy` å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆæ¥å®ç°ä¸€ä¸ªç”Ÿæˆ `Proxy` å¯¹è±¡çš„å‡½æ•°ã€‚

```js
// ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸º proxy å¯¹è±¡
const isProxy = value => !!value && !!value[MY_IMMER]
// å­˜æ”¾ç”Ÿæˆçš„ proxy å¯¹è±¡
const proxies = new Map()
const getProxy = data => {
  if (isProxy(data)) {
    return data
  }
  if (isPlainObject(data) || Array.isArray(data)) {
    if (proxies.has(data)) {
      return proxies.get(data)
    }
    const proxy = new Proxy(data, objectTraps)
    proxies.set(data, proxy)
    return proxy
  }
  return data
}
```

- é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¼ å…¥çš„å±æ€§æ˜¯ä¸æ˜¯å·²ç»ä¸ºä¸€ä¸ª proxy å¯¹è±¡ï¼Œå·²ç»æ˜¯çš„è¯ç›´æ¥è¿”å›å³å¯ã€‚è¿™é‡Œåˆ¤æ–­çš„æ ¸å¿ƒæ˜¯é€šè¿‡ `value[MY_IMMER]`ï¼Œå› ä¸ºåªæœ‰å½“æ˜¯ proxy å¯¹è±¡ä»¥åæ‰ä¼šè§¦å‘æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‹¦æˆª `get` å‡½æ•°ï¼Œåœ¨æ‹¦æˆªå‡½æ•°ä¸­åˆ¤æ–­å¦‚æœ `key` æ˜¯ `MY_IMMER` çš„è¯å°±è¿”å› `target`
- æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åˆ¤æ–­å‚æ•°æ˜¯å¦æ˜¯ä¸€ä¸ªæ­£å¸¸ `Object` æ„é€ å‡ºæ¥çš„å¯¹è±¡æˆ–æ•°ç»„ï¼Œ`isPlainObject` ç½‘ä¸Šæœ‰å¾ˆå¤šå®ç°ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥åœ¨æ–‡æœ«é˜…è¯»æºç 
- æœ€åæˆ‘ä»¬éœ€è¦åˆ¤æ–­ç›¸åº”çš„ proxy æ˜¯å¦å·²ç»åˆ›å»ºè¿‡ï¼Œåˆ›å»ºè¿‡çš„è¯ç›´æ¥ä» `Map` ä¸­æ‹¿å³å¯ï¼Œå¦åˆ™å°±æ–°åˆ›å»ºä¸€ä¸ªã€‚æ³¨æ„è¿™é‡Œç”¨äºå­˜æ”¾ proxy å¯¹è±¡çš„å®¹å™¨æ˜¯ `Map` è€Œä¸æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç”¨æ™®é€šå¯¹è±¡å­˜æ”¾çš„è¯ï¼Œåœ¨å–å€¼çš„æ—¶å€™ä¼šå‡ºç°**çˆ†æ ˆ**ï¼Œå…·ä½“åŸå› å¤§å®¶å¯ä»¥è‡ªè¡Œæ€è€ƒğŸ¤”

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ¥å®ç° proxy çš„æ‹¦æˆªå‡½æ•°ï¼Œè¿™é‡Œæœ‰ä¸Šæ–‡è¯´è¿‡çš„ä¸¤ä¸ªæ ¸å¿ƒæ€è·¯ã€‚

```js
// æ³¨æ„è¿™é‡Œè¿˜æ˜¯ç”¨åˆ°äº† Mapï¼ŒåŸç†å’Œä¸Šæ–‡è¯´çš„ä¸€è‡´
const copies = new Map()
const objectTraps = {
  get(target, key) {
    if (key === MY_IMMER) return target
    const data = copies.get(target) || target
    return getProxy(data[key])
  },
  set(target, key, val) {
    const copy = getCopy(target)
    const newValue = getProxy(val)
    // è¿™é‡Œçš„åˆ¤æ–­ç”¨äºæ‹¿ proxy çš„ target
    // å¦åˆ™ç›´æ¥ copy[key] = newValue çš„è¯å¤–éƒ¨æ‹¿åˆ°çš„å¯¹è±¡æ˜¯ä¸ª proxy
    copy[key] = isProxy(newValue) ? newValue[MY_IMMER] : newValue
    return true
  }
}
const getCopy = data => {
  if (copies.has(data)) {
    return copies.get(data)
  }
  const copy = Array.isArray(data) ? data.slice() : { ...data }
  copies.set(data, copy)
  return copy
}
```

- æ‹¦æˆª `get` çš„æ—¶å€™é¦–å…ˆéœ€è¦åˆ¤æ–­ `key` æ˜¯ä¸æ˜¯ `MY_IMMER`ï¼Œæ˜¯çš„è¯è¯´æ˜è¿™æ—¶å€™è¢«è®¿é—®çš„å¯¹è±¡æ˜¯ä¸ª `proxy`ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ­£ç¡®çš„ `target` è¿”å›å‡ºå»ã€‚ç„¶åå°±æ˜¯æ­£å¸¸è¿”å›å€¼äº†ï¼Œå¦‚æœå­˜åœ¨ copy å°±è¿”å› copyï¼Œå¦åˆ™è¿”å›åŸæ•°æ®
- æ‹¦æˆª `set` çš„æ—¶å€™ç¬¬ä¸€æ­¥è‚¯å®šæ˜¯ç”Ÿæˆä¸€ä¸ª copyï¼Œå› ä¸ºèµ‹å€¼æ“ä½œæˆ‘ä»¬éƒ½éœ€è¦åœ¨ copy ä¸Šè¿›è¡Œï¼Œå¦åˆ™ä¼šå½±å“åŸæ•°æ®ã€‚ç„¶ååœ¨ copy ä¸­èµ‹å€¼æ—¶ä¸èƒ½æŠŠ proxy å¯¹è±¡èµ‹å€¼è¿›å»ï¼Œå¦åˆ™æœ€åç”Ÿæˆçš„ä¸å¯å˜å¯¹è±¡å†…éƒ¨ä¼šå†…å­˜ proxy å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸‹æ˜¯å¦ä¸º proxy å¯¹è±¡
- åˆ›å»º copy çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­æ•°æ®çš„ç±»å‹ç„¶åè¿›è¡Œæµ…æ‹·è´æ“ä½œ

æœ€åå°±æ˜¯ç”Ÿæˆä¸å¯å˜å¯¹è±¡çš„é€»è¾‘äº†

```js
const isChange = data => {
  if (proxies.has(data) || copies.has(data)) return true
}

const finalize = data => {
  if (isPlainObject(data) || Array.isArray(data)) {
    if (!isChange(data)) {
      return data
    }
    const copy = getCopy(data)
    Object.keys(copy).forEach(key => {
      copy[key] = finalize(copy[key])
    })
    return copy
  }
  return data
}
```

è¿™é‡Œçš„é€»è¾‘ä¸Šæ–‡å…¶å®å·²ç»è¯´è¿‡äº†ï¼Œå°±æ˜¯åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚æ²¡æœ‰ä¿®æ”¹è¿‡çš„è¯å°±ç›´æ¥è¿”å›åŸæ•°æ®å¹¶ä¸”åœæ­¢è¿™ä¸ªåˆ†æ”¯çš„éå†ï¼Œå¦‚æœä¿®æ”¹è¿‡çš„è¯å°±ä» copy ä¸­å–å€¼ï¼Œç„¶åæŠŠæ•´ä¸ª copy ä¸­çš„å±æ€§éƒ½æ‰§è¡Œä¸€é `finalize` å‡½æ•°ã€‚

æœ€åä¸€æ­¥å°±æ˜¯æŠŠä¸Šæ–‡æ‰€è¯´çš„å‡½æ•°å…¨éƒ¨æ•´åˆåœ¨ä¸€èµ·

```js
function produce(baseState, fn) {
  // ...
  const proxy = getProxy(baseState)
  fn(proxy)
  return finalize(baseState)
}
```

ä»¥ä¸Šå°±æ˜¯æ•´ä¸ªæ€è·¯å®ç°äº†ï¼Œè®©æˆ‘ä»¬æ¥æ£€éªŒä¸‹æ˜¯å¦èƒ½æ­£å¸¸å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚

```js
const state = {
  info: {
    name: 'yck',
    career: {
      first: {
        name: '111'
      }
    }
  },
  data: [1]
}

const data = produce(state, draftState => {
  draftState.info.age = 26
  draftState.info.career.first.name = '222'
})

console.log(data, state)
console.log(data.data === state.data)
```

ä»ä¸Šè¿°ä»£ç æ‰“å°å‡ºçš„å€¼æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `data` å’Œ `state` å·²ç»ä¸æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œä¿®æ”¹ `data` ä¸ä¼šå¼•å‘åŸæ•°æ®çš„å˜æ›´ï¼Œå¹¶ä¸”ä¹Ÿå®ç°äº†åªæµ…æ‹·è´ä¿®æ”¹è¿‡çš„å±æ€§ã€‚å¯¹è±¡ä¸­çš„ `data` å±æ€§å› ä¸ºæ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œæ‰€æœ‰ä¸¤ä¸ªå¯¹è±¡ä¸­çš„ `data` è¿˜æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œå®ç°äº†ç»“æ„å…±äº«ã€‚

## æœ€å

æ‘†ä¸Š [æºç åœ°å€](https://github.com/KieSun/Dream/blob/master/content/toys/deepClone/index.js)ï¼Œå…¶å® immer å†…éƒ¨è¿œä¸æ­¢è¿™äº›å®ç°ä»£ç ï¼Œå…¶ä¸­ä¼šæœ‰æ›´å¤šçš„æ•°æ®æ£€éªŒä»¥åŠå…¼å®¹æ€§åˆ¤æ–­ï¼Œæœ¬æ–‡çš„ä»£ç æ›´å¤šçš„æ˜¯æä¾›ä¸€ç§ä¸ä¸€æ ·çš„æ·±æ‹·è´å®ç°æ€è·¯ã€‚

å„ä½è¯»è€…æœ‰ä»»ä½•ç–‘é—®æˆ–è€…å…¶ä»–é—®é¢˜éƒ½å¯ä»¥åœ¨è¯„è®ºåŒºä¸­äº¤æµã€‚

![](https://user-gold-cdn.xitu.io/2019/8/4/16c5d08fa4076d33?w=274&h=357&f=png&s=72221)